{% extends 'brambling/event/order/__base.html' %}

{% load floppyforms zenaida %}

{% block title %}Assign items to attendees â€“ {{ block.super }}{% endblock %}

{% block javascripts %}
	{{ block.super }}

	{% include 'brambling/event/order/_use_discount_js.html' %}

	<script>
		$(function(){
			$('a[target]').on('click', function(e){
				e.preventDefault();
				$.post($(this).attr('target'), function(){
					// For now, just reload the page.
					location.reload();
				});
			})
		});
	</script>
{% endblock %}

{% block main %}
	{{ block.super }}

	<div class="row">
		<div class="col-md-8">
			<div class="row margin-trailer">
				{% for attendee in attendees %}
					<div class='col-md-6'>
						{% url "brambling_event_attendee_edit" pk=attendee.pk event_slug=event.slug organization_slug=event.organization.slug as attendee_url %}
						{% url "brambling_event_attendee_remove" pk=attendee.pk event_slug=event.slug organization_slug=event.organization.slug as attendee_remove_url %}
						<div class='panel panel-primary'>
							<div class='panel-heading'>
								<div class='panel-title'>
									<a href='{{ attendee_url }}'>
										{{ attendee.get_full_name }}
									</a>
									<a class='remove-link pull-right' href='{{ attendee_remove_url }}' target="{{ attendee_remove_url }}">
										<i class='fa fa-fw fa-trash'></i>
									</a>
									<a href='{{ attendee_url }}' class="pull-right">
										<i class='fa fa-fw fa-pencil'></i>
									</a>
								</div>
							</div>
							{% if attendee.items or attendee.errors %}
								<ul class='list-group'>
									{% for item in attendee.items %}
										<li class='list-group-item'>{{ item.item_option_name }} ({{ item.item_name }})</li>
									{% endfor %}
									{% for error in attendee.errors %}
										<li class='list-group-item list-group-item-danger'>
											{{ error }}
										</li>
									{% endfor %}
								</ul>
							{% endif %}
						</div>
					</div>
					{% cycle "" '<div class="clearfix visible-md-block visible-lg-block"></div>' %}
				{% endfor %}
				<div class='col-md-4'><a class='btn btn-primary' href='{% url "brambling_event_attendee_add" event_slug=event.slug organization_slug=event.organization.slug %}'>
					<i class='fa fa-fw fa-plus'></i> Add attendee
				</a></div>
			</div>
		</div>
		<div class='col-md-4'>
			<div class='panel panel-default'>
				<div class='panel-heading'>
					<h4 class='panel-title'>Unassigned items</h4>
				</div>
				<ul class='list-group'>
					{% if unassigned_items %}
						{% regroup unassigned_items by item_name as item_list %}
						{% for item in item_list %}
							<li class='list-group-item'><strong>{{ item.grouper }}</strong></li>
							{% for bought_item in item.list %}
								<li class='list-group-item'>{{ bought_item.item_option_name }}</li>
							{% endfor %}
						{% endfor %}
						{% if errors.bought_items %}
							{% for error in errors.bought_items %}
								<li class='list-group-item list-group-item-danger'>
									{{ error }}
								</li>
							{% endfor %}
						{% endif %}
					{% else %}
						<li class='list-group-item'>
							No unassigned items remain.
						</li>
					{% endif %}
				</ul>
				<div class='panel-footer'>
					<a class='btn btn-default btn-block' href='{% url "brambling_event_shop" event_slug=event.slug organization_slug=event.organization.slug %}'>
						Return to shop for more
					</a>
				</div>
			</div>
			<p class='help-block'>All items must be assigned to an attendee</p>
		</div>
	</div>
{% endblock %}
