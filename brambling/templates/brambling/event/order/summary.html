{% extends 'brambling/event/order/__base.html' %}

{% load floppyforms zenaida %}

{% block title %}Order summary â€“ {{ block.super }}{% endblock %}

{% block javascripts %}
	{{ block.super }}

	<script type='text/javascript'>
		var discountReload = true;
	</script>
	{% include 'brambling/event/order/_use_discount_js.html' %}
	{% if event.uses_stripe %}
		{% include "brambling/_stripe_js.html" %}
		<script>
			function set_stripe_key() {
				if ($('#id_save_card').prop('checked')) {
					Stripe.setPublishableKey('{% if event and event.api_type == event.TEST %}{{ STRIPE_TEST_PUBLISHABLE_KEY }}{% else %}{{ STRIPE_PUBLISHABLE_KEY }}{% endif %}');
				} else {
					Stripe.setPublishableKey('{% if event and event.api_type == event.TEST %}{{ event.stripe_test_publishable_key }}{% else %}{{ event.stripe_publishable_key }}{% endif %}')
				}
			}
			$('#id_save_card').on('change', function(e) {
				set_stripe_key();
			});
			$(set_stripe_key);
		</script>
	{% endif %}
{% endblock %}

{% block next_step_button %}
	<form class=''>
		<div class='input-group input-group-lg'>
			<input id='discountCode' class='form-control' placeholder='Discount code' autocomplete='off'>
			<span class='input-group-btn'>
				<button id='discountCodeButton' class='btn btn-success' type='submit' data-slug="{{ event.slug }}"><span class='fa fa-plus'></span></button>
			</span>
		</div>
	</form>
{% endblock %}

{% block main %}
	{% with next_step=1 %}
		{{ block.super }}
	{% endwith %}

	{% if net_balance > 0 %}
		<div class="alert alert-warning">
			Your order is not yet complete. Please review your order and use one
			of the payment options below to complete your order.
		</div>
	{% elif unconfirmed_check_payments %}
		<div class="alert alert-warning">
			<p>Your passes are reserved, but the organizer has not yet received your payment by mail.</p>
			{% include "brambling/event/order/_check_payment_info.html" %}
			<p>If you mailed your check more than a week ago or believe this is in error, please contact the event organizer directly.</p>
		</div>
	{% else %}
		<div class="alert alert-success">
			Your order is complete. Below is a record of your purchases and your
			payment.
		</div>
	{% endif %}

	{% if order and not order.person %}<h1><a href="{% url 'brambling_event_order_summary' event_slug=event.slug code=order.code %}">Order {{ order.code }}</a></h1>{% endif %}

	{% include "brambling/event/order/_summary.html" %}

	{# START PAYMENT OPTIONS #}

	{% if net_balance > 0 %}
		<p>A receipt for this purchase will be sent to
			{% if order.person %}
			<strong>{{ order.person.name }} ({{ order.person.email }})</strong>.
			{% elif order.email %}
			<strong>{{ order.email }}</strong>.
			{% endif %}
		</p>

		{% if event.uses_stripe %}
			{% if has_cards %}
				<div class="panel-group" id="accordion">
					<div class="panel panel-default">
						<div class="panel-heading">
							<h4 class="panel-title">
								<a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
									Pay with a saved card
								</a>
							</h4>
						</div>
						<div id="collapseOne" class="panel-collapse collapse{% if not request.POST.new_card %} in{% endif %}">
							<div class="panel-body">
								<form novalidate action="" method="post">
									{% csrf_token %}
									<input name='choose_card' value='1' type='hidden'>
									{% formrow choose_card_form.card %}

									{% for error in choose_card_form.non_field_errors %}
										<div class='alert alert-danger'>
											{{ error }}
										</div>
									{% endfor %}

									<button type="submit" class="btn btn-primary">Pay now ({{ net_balance|format_money:event.currency }})</button>
								</form>
							</div>
						</div>
					</div>
					<div class="panel panel-default">
						<div class="panel-heading">
							<h4 class="panel-title">
								<a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
									Pay with a new card
								</a>
							</h4>
						</div>
						<div id="collapseTwo" class="panel-collapse collapse{% if request.POST.new_card %} in{% endif %}">
							<div class="panel-body">
			{% endif %}

			{% include 'brambling/_stripe_form.html' %}
			<form novalidate action="" method="post" id='card-form'>
				{% csrf_token %}
				<input name='new_card' value='1' type='hidden'>

				{% if new_card_form.save_card %}{% formrow new_card_form.save_card %}{% endif %}

				{% for error in new_card_form.non_field_errors %}
					<div class='alert alert-danger'>
						{{ error }}
					</div>
				{% endfor %}

				<button type="submit" id='card-submit' class="btn btn-primary">Pay now ({{ net_balance|format_money:event.currency }})</button>
			</form>

			{% if has_cards %}
							</div>
						</div>
					</div>
				</div>
			{% endif %}
			{% include 'brambling/_stripe_note.html' %}
		{% endif %}
		{% if event.uses_dwolla %}
			{% if dwolla_is_connected or dwolla_oauth_url %}
			<div class="panel panel-default">
				<div class="panel-heading">
					<h4 class="panel-title">
						Pay with Dwolla
					</h4>
				</div>
				<div class="panel-body">
					{% if dwolla_is_connected %}
						<p>Connected account: {{dwolla_user_id }}</p>
						<form novalidate action="" method="post">
							{% csrf_token %}
							<input name='dwolla' value='1' type='hidden'>

							{% formrow dwolla_form.dwolla_pin with autocomplete="off" %}

							{% for error in dwolla_form.non_field_errors %}
								<div class='alert alert-danger'>
									{{ error }}
								</div>
							{% endfor %}

							<button type="submit" class="btn btn-primary">Pay now ({{ net_balance|format_money:event.currency }})</button>
						</form>
					{% else %}
						<a href='{{ dwolla_oauth_url }}' class='btn btn-primary'>Connect to Dwolla <i class='fa fa-external-link'></i></a>
					{% endif %}
				</div>
			</div>
			{% endif %}
		{% endif %}

		{# Payment by check #}
		{# TODO: Disallowing payment by check after the cutoff should also be enforced on the view end. #}
		{% if event.uses_checks and event.check_postmark_cutoff %}
			{% td_to_dict event.check_postmark_cutoff|td_timeuntil as time_until_check_cutoff %}
			{% if time_until_check_cutoff.days >= 0 %}
				<div class="panel panel-default">
					<div class="panel-heading">
						<h4 class="panel-title">
							Pay with check
						</h4>
					</div>
					<div class="panel-body">
						{% include "brambling/event/order/_check_payment_info.html" %}
						<form novalidate action="" method="post">
							{% csrf_token %}
							<input name='check' value='1' type='hidden'>

							<button type="submit" class="btn btn-primary">Complete Order ({{ net_balance|format_money:event.currency }})</button>
						</form>
					</div>
				</div>
			{% endif %}
		{% endif %}

	{% elif order.has_cart %}
		<form novalidate action="" method="post">
			{% csrf_token %}
			<button type="submit" class="btn btn-primary">Confirm cart purchases</button>
		</form>
	{% endif %}

	{# END PAYMENT OPTIONS #}
{% endblock %}
