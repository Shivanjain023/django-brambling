{% extends 'brambling/layouts/12_sm.html' %}

{% load floppyforms static %}

{% block title %}Profile settings â€“ {{ block.super }}{% endblock %}

{% block javascripts %}
	{{ block.super }}
	<script>
		$('.remove-card').on('click', function(e) {
			var $this = $(this);
			e.preventDefault();
			$.post($this.attr('target'), function() {
				$this.parent().parent().fadeOut();
			});
		});
	</script>
{% endblock %}

{% block main %}
	<h2>Edit settings</h2>

	<form action="{{ request.path }}" method="post">
		{% csrf_token %}
		{% form form using "brambling/forms/person.html" %}
		<div class="panel panel-default">
			<header class="panel-heading">
				<h4 class="panel-title">Payment</h4>
			</header>
			<div class="panel-body">
				{% if form.STRIPE_APPLICATION_ID %}
					<h3>Stripe <small><a class='btn btn-link' href='{% url "brambling_user_card_add" %}'><span class='fa fa-plus'></span> Add another card</a></small></h3>
					{% if cards %}
						{% for card in cards %}
							<div class='clearfix'>
								<h5>{{ card.brand }} <span class='pull-right'>&bull;&bull;&bull;&bull;{{ card.last4 }}</span></h5>
								<p>
									<span class='text-muted'>Expires {{ card.exp_month }}/{{ card.exp_year }}</span>
									<a target='{% url "brambling_user_card_delete" pk=card.pk %}' href="javascript://" class='pull-right text-danger remove-card'><span class='fa fa-times'></span></a>
								</p>
							</div>
						{% endfor %}
					{% else %}
						<p>No credit cards on record.</p>
					{% endif %}
				{% endif %}

				{% if form.DWOLLA_APPLICATION_KEY %}
					<h3>Dwolla</h3>
					{% if form.instance.dwolla_user_id %}
						<p>Connected account: {{ form.instance.dwolla_user_id }}</p>
						{% formrow form.disconnect_dwolla with label="Disconnect" %}
					{% else %}
						<a href='https://uat.dwolla.com/oauth/v2/authenticate?client_id={{ form.DWOLLA_APPLICATION_KEY }}&response_type=code&redirect_uri=http://{{ request.get_host }}{% url "brambling_user_dwolla_connect" %}&scope=Send|AccountInfoFull' class='btn btn-primary'>Connect to Dwolla <i class='fa fa-external-link'></i></a>
					{% endif %}
				{% endif %}
			</div>
		</div>
		<button class="btn btn-primary" type="submit">Save changes</button>
		<a href="{{ event.get_absolute_url }}" class="btn btn-link">Cancel</a>
	</form>

{% endblock %}
